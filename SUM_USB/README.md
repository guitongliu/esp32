# ESP32 EMG数据采集汇聚系统

## 系统概述

这是一个基于ESP32-S3的肌电信号(EMG)数据采集汇聚系统，作为WiFi接入点接收来自多个传感器节点的数据，并通过USB CDC虚拟串口将汇聚后的数据发送给上位机。

## 系统架构

### 硬件架构
- **主控**: ESP32-S3 (双核Xtensa LX7处理器)
- **通信**: WiFi 2.4GHz + USB CDC
- **节点数量**: 最多支持4个EMG传感器节点
- **数据传输**: 实时1KHz采样频率

### 软件架构
```
┌─────────────────┐    WiFi     ┌──────────────────┐    USB CDC    ┌─────────────┐
│   EMG节点1-4    │ ──────────► │    ESP32-S3      │ ──────────► │   上位机     │
│   (传感器)      │             │   (数据汇聚)     │             │  (数据处理)  │
└─────────────────┘             └──────────────────┘             └─────────────┘
                                         │
                                    ESP-IDF定时器
                                    (1KHz触发)
```

## 核心数据结构

### NodeData - 节点数据结构
```cpp
typedef struct {
  struct { uint8_t ch1[3]; } adc[8];  // 8通道ADC数据，每通道3字节(24位)
  struct { float x, y, z; } imu[2];   // 2个IMU传感器的xyz轴数据
} NodeData;  // 总大小: 48字节
```

### TimeSlot - 时间槽结构
```cpp
typedef struct {
  NodeData nodes[NODE_MAXCOUNT];          // 存储4个节点的数据
  std::bitset<NODE_MAXCOUNT> readyFlags;  // 标记节点数据就绪状态
} TimeSlot;
```

## 数据流处理

### 1. 数据接收流程
```
WiFi数据包 → 网络缓冲区 → 数据包解析 → processData() → 活动收集槽位
```

**数据包格式**:
- 长度(2字节) + 节点ID(1字节) + NodeData(48字节) = 总共51字节

### 2. 数据缓存机制
系统采用双级缓存:

#### 第一级: 活动收集槽位 (activeCollectionSlotData)
- 实时收集来自各节点的数据
- 使用bitset标记各节点数据就绪状态
- 当所有节点数据到齐时，提交到环形缓冲区

#### 第二级: 环形缓冲区 (timeSlots[])
- 10个槽位的环形队列
- currentWriteSlot: 写入指针
- currentReadSlot: 读取指针
- 缓冲区满时自动丢弃最老数据

### 3. 数据发送流程
```
环形缓冲区 → sendCombinedData() → 数据打包 → CRC校验 → USB CDC发送
```

**发送包格式**:
```
包头(4字节): [0xAA, 0x55, 节点数量, 数据大小]
数据段: [节点ID(1字节) + NodeData(48字节)] × N
CRC校验(2字节): [CRC_HIGH, CRC_LOW]
```

## 多任务架构

### 任务分配策略
- **CPU核心0**: USB命令处理 + 数据发送定时器
- **CPU核心1**: 网络数据接收处理

### 任务详情

#### 1. taskNetwork (核心1, 优先级5)
- **功能**: WiFi客户端连接管理和数据接收
- **技术**: 使用select()系统调用实现高效多路I/O
- **性能优化**: 
  - 10微秒超时的非阻塞I/O
  - 限制每轮最多处理2个数据包防止阻塞
  - 智能延迟策略(仅在无数据无连接时延迟)

#### 2. taskUSBCommand (核心0, 优先级4)
- **功能**: 接收上位机命令并广播到所有节点
- **协议**: 固定8字节命令帧
- **容错**: 100ms超时处理，防止命令同步错误

#### 3. sendTimerCallback (ESP-IDF定时器)
- **触发频率**: 1KHz (每1毫秒)
- **功能**: 调用sendCombinedData()发送数据
- **实时性**: 使用ESP-IDF高精度定时器保证时序

## 网络配置

### WiFi热点设置
- **SSID**: "ESP32_SUM"
- **密码**: "123456789"
- **信道**: 6
- **IP配置**:
  - AP地址: 192.168.4.1
  - 节点地址: 192.168.4.2 ~ 192.168.4.5
- **端口**: 12345 (数据传输)

### 连接管理
- 支持节点断线重连
- 基于IP地址的节点识别
- 自动资源清理和释放

## 性能特性

### 实时性保证
- **1KHz数据发送频率**: ESP-IDF定时器精确控制
- **低延迟网络处理**: select()非阻塞I/O + 10μs超时
- **双核并行处理**: 网络和USB处理分离

### 数据完整性
- **CRC16校验**: 使用标准CCITT多项式(0x1021)
- **环形缓冲**: 防止数据丢失，满时丢弃最老数据
- **数据包验证**: 长度和格式校验

### 容错能力
- **连接恢复**: 自动处理节点断线重连
- **缓冲区溢出保护**: 自动清理防止内存泄漏
- **超时处理**: 命令接收和数据处理超时机制

## 性能监控

### 调试计数器
```cpp
static uint32_t send_attempts = 0;      // 发送尝试次数
static uint32_t send_successes = 0;     // 发送成功次数
static uint32_t frames_committed = 0;   // 提交帧数
static uint32_t data_processed_count[]; // 各节点处理计数
```

### 实时状态显示
每秒输出统计信息:
- 提交到缓冲区的帧数
- 活动收集槽位状态
- 各节点数据处理计数

## 配置参数

### 关键宏定义
```cpp
#define NODE_MAXCOUNT 4                    // 最大节点数
#define BUFFER_SLOTS 10                    // 环形缓冲槽数
#define NODE_EXPECTED 4                    // 期望节点数
#define MAX_BUFFER_SIZE 2048              // 网络缓冲区大小
#define CMD_FRAME_SIZE 8                  // 命令帧大小
#define MAX_PACKETS_PER_NODE_PER_ITERATION 2  // 每轮最大处理包数
```

### 性能调优
- **网络超时**: 10微秒(高响应性)
- **任务延迟**: 动态调整(有数据时无延迟)
- **定时器精度**: 1毫秒(1KHz发送)

## 编译和使用

### 环境要求
- PlatformIO
- ESP32-S3开发板
- ESP-IDF框架

### 编译配置
```ini
[env]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
```

### 运行模式
1. **初始化**: 启动WiFi热点和任务
2. **连接**: 等待EMG节点连接
3. **数据采集**: 实时接收和汇聚数据
4. **数据传输**: 1KHz频率发送到上位机

## 故障排除

### 常见问题
1. **数据丢失**: 检查缓冲区大小和网络延迟
2. **连接不稳定**: 检查WiFi信号强度和IP配置
3. **发送延迟**: 检查USB连接和上位机处理能力

### 调试方法
- 启用Serial输出查看统计信息
- 监控各节点连接状态
- 检查缓冲区使用情况

## 扩展性

### 支持更多节点
- 修改`NODE_MAXCOUNT`宏
- 增加IP地址池
- 调整缓冲区大小

### 协议扩展
- 支持更多数据类型
- 添加数据压缩
- 实现数据加密

---

*本文档描述的是ESP32 EMG数据采集汇聚系统的完整技术实现。*
